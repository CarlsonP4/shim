<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SciDB Simple Telemetry Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link href="css/bootstrap.css" rel="stylesheet">
 <style type="text/css">
.label {
  font-weight: bold;
}

.tile {
  shape-rendering: crispEdges;
}

.chart
{
  background-color: rgba(0,0,0,0.05);
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

div.meter
{
  float: left;
  margin-left: 20px;
  margin-bottom: 20px;
  width: 50px;
  height: 50px;
  overflow: hidden;
  border: 1px solid #aaa;
  resize: both;
}

body {
  padding-top: 60px;
  padding-bottom: 40px;
}


</style>
<link href="css/bootstrap-responsive.css" rel="stylesheet">
<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
  <script src="../assets/js/html5shiv.js"></script>
<![endif]-->
<link rel="apple-touch-icon-precomposed" href="img/favicon.png">
<link rel="shortcut icon" href="img/favicon.ico">
</head>

<body>

  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="index.html">SciDB</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="query.html">Interactive Query</a></li>
          </ul>
          <div class="pull-right">
            <ul class="nav">
            <li><a href="http://paradigm4.com">http://paradigm4.com</a>
            <ul>
          </div>
        </div><!--/.nav-collapse -->
      </div>
    </div>
  </div>

<div id="loadavg" class="meter">
load average plot
</div>
<div class="meter" id="freemem">
percent free memory plot
</div>
<div class="meter" id="disk">
percent disk use plot
</div>

</body>
<script src="js/d3.js"></script>
<script language="javascript" type="text/javascript">
// Global array of raw telemetry data.
telemetry = [];


window.onload = function()
{
  var protocol = "ws://";
  if(location.protocol == "https:") protocol = "wss://";
  var url = protocol + window.location.host + "/telemetry";
  websocket = new WebSocket(url);
  websocket.onopen = function(ev)
  {
  };
  websocket.onclose = function(ev)
  {
//    location.reload(); // Try to reload page
  };
  websocket.onmessage = function(ev)
  {
// Magic happens here
// Append new telemetry data
    telemetry = telemetry.concat(csv2array(ev.data));
// Truncate when it gets too big... XXX TODO
// Plot
    var p = ago(telemetry);
    canned_heat(p,2,"% Free mem","Seconds ago","host","#freemem","#eef","#00f")
    canned_heat(p,3,"CPU Load avg","Seconds ago","host","#loadavg","#ff5","red")
// Plot the disk stats...
    var javier = bardem(p, 4);
    canned_heat(javier,2,"% Disk free","Seconds ago","host","#disk","#eef","#00f")
  };
  websocket.onerror = function(ev)
  {
//    console.log("websocket error "+ev.data);
  };
};

var csv2array = function(X)
{
  var ans = X.split("\n").filter(function(x){return x.length>2;}).map(function(x){return x.split(",");});
  ans = ans.map(function(x){
                  var y=x;
                  y[0] = Number(x[0]);       // Time  in 1s
                  y[2] = Number(y[2]);       // Free memory percent
                  y[3] = Number(y[3]);       // One minute load avg.
                  return y;});
  return ans;
}

var ago = function(X)
{
  var max_time = d3.max(X, function(x){return x[0];});
  var ans = X.map(function(x){
               return [max_time - x[0]].concat(x.slice(1,x.length))});
  return ans;
}

var example_data =
{
  name: "Load average",
  xlab: "Seconds ago",
  ylab: "Host",
  data : [
[0, "homer", 7],
[0, "elmo",3],
[0, "duke",5],
[1, "homer", 5],
[1, "elmo",2],
[1, "duke",2],
[2, "homer", 4],
[2, "elmo",1],
[2, "duke",2],
[3, "homer", 5],
[3, "elmo",3],
[3, "duke",4],
]};
// Could plot this with:
// canned_heat(example_data.data, 2, "example","time","host","#mydiv","white","red")

/*
 * canned_heat
 * Plot time-series heatmaps of telemetry data.
 * heat: An array with at least three columns: time, hostname, value.
 *       Additional columns may be present.
 * pos: column position in the data array of the measurement values
 * name: name of the measurement
 * xlab: x-axis label
 * ylab: y-axis label
 * div: A string ID selector for the div to draw in. For example "#mydiv".
 * lowcol: low color limit
 * highcol: high color limit
 * Draws a time-series heat map, most recent times on the right.
 */
var canned_heat = function(heat, pos, name, xlab, ylab, div, lowcol, highcol)
{
  d3.select(div)[0][0].innerHTML="";
  var wd = parseInt(d3.select(div).style("width"));
  var ht = parseInt(d3.select(div).style("height"));
  if(wd < 100){wd = 500; d3.select(div).style("width",wd+"px");}
  if(ht < 100){ht = 300; d3.select(div).style("height",ht+"px");}

// obtain a list of unqiue host names
  var hosts = heat.map(function(x) {return x[1];}).filter(function(value,index,self){return self.indexOf(value) === index;});
  var mxlen = d3.max(hosts.map(function(x){return x.length}));

// Set figure margins
  var margin = {top: 20, right: 110, bottom: 30, left: mxlen*10},
    width = wd - margin.left - margin.right,
    height = ht - margin.top - margin.bottom;

  var svg = d3.select(div).append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .attr("class", "chart")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var x = d3.scale.linear().range([width,0]),
      y = d3.scale.ordinal().domain(hosts).rangeBands([height, 0]),
      z = d3.scale.linear().range([lowcol, highcol]);
  var xStep = 10;

  // Compute the scale domains.
  x.domain(d3.extent(heat, function(d) { return d[0]; }));
  z.domain([0, d3.max(heat, function(d) { return d[pos]; })]);

  // Extend the domains to fit the last value
  x.domain([x.domain()[0], x.domain()[1] + xStep]);

  // Display the tiles
  svg.selectAll(".tile")
      .data(heat)
    .enter().append("rect")
      .attr("class", "tile")
      .attr("x", function(d) { return x(d[0] + xStep); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("width", Math.abs(x(xStep) - x(0)))
      .attr("height",  y(0) - y(1))
      .style("fill", function(d) { return z(d[pos]); });

  // Add a legend for the color values.
  var legend = svg.selectAll(".legend")
      .data(z.ticks(6).slice(1).reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(" + (width + 20) + "," + (20 + i * 20) + ")"; });

  legend.append("rect")
      .attr("width", 20)
      .attr("height", 20)
      .style("fill", z);

  legend.append("text")
      .attr("x", 26)
      .attr("y", 10)
      .attr("dy", ".35em")
      .text(String);

  svg.append("text")
      .attr("class", "label")
      .attr("x", width + 20)
      .attr("y", 10)
      .attr("dy", ".35em")
      .text(name);

  // Add an x-axis with label.
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.svg.axis().ticks(5).scale(x).orient("bottom"))
    .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .attr("text-anchor", "end")
      .text(xlab);

  // Add a y-axis with label.
  // XXX Somehow the y scale is getting messed up. We reset it.
      y = d3.scale.ordinal().domain(hosts).rangeBands([height, 0]);
  svg.append("g")
      .attr("class", "y axis")
      .call(d3.svg.axis().scale(y).orient("left"))
};




/* Parse fields reporting multiple values. Each value is assumed to be bar
 * delimited, and within each value a space delimited tuple of label and value.
 * Example:
   time      hn   val1 val2 bar-delimited tuples
 * 123456789,host,12.3,1.2,/dev/sda1 85|/dev/sda2 92
 * The tuples are concatenated with the host name and enumerated along the
 * y-axis.
 * So many for loops! Oh no!
 */
var bardem = function(X, pos)
{
  var ans = [];
  for(var j=0;j < X.length;++j)
  {
    var v = X[j][pos];
    if(v == undefined) continue;
    v = v.split("|");
    if(v.length > 0)
    {
      for(var k=0;k < v.length - 1;++k)
      {
        var u = v[k].split(" ");
// Note that we subtract the value from 100, useful to bring df's disk
// usage value into the scame scale as percent free x
        if(u.length>1) ans.push([X[j][0], X[j][1] + ":" + u[0], 100 - Number(u[1])]);
      }
    }
  }
  return ans;
}
</script>
